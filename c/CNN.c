#include <stdio.h>

int main(void) {


/*==============Read picture===============================================================*/

	FILE *fp;

	fp = fopen("5.bmp", "rb");

	unsigned char buffer[3072];

	if (!fp)
	{
	printf("read fial.");
	}
	

	fseek(fp, 54, SEEK_SET);

	fread(buffer, sizeof(char), 3072, fp);


	float pic[32][32];

	int k = 0;

	for (int i = 31; i >= 0; i--)
	{
		for (int j = 0; j < 32; j++)
		{
			pic[i][j] = buffer[k];
			k = k + 3;
		}
	}
	for (int i = 0; i < 32; i++)
	{
		for (int j = 0; j < 32; j++)
		{
			printf("%4.0f", pic[i][j]);
		}
		printf("\n");
	}

	fclose(fp);

	printf("\n\n\n");

/*==================================================================================*/


/*=============Weight================================================================*/
	float conv1_weight[2][5][5] = 
	{ 
		{	
			{ -0.318983	,0.27412	,0.408678	,0.0442329	,0.310208 }, // The 1 group
			{ -0.289788	,0.0116981	,0.524899	,0.369115	,0.374784 },
			{ -0.120985	,0.54898	,0.498662	,0.29271	,0.628671 },
			{  0.29497	,0.338124	,0.538512	,0.320949	,0.0371361},
			{  0.0172263,0.210725	,0.415999	,0.110917	,0.184655 }
		},
		{	
			{ -0.116636	,-0.284407	,-0.0657045	,0.130546	,0.176478 }, // The 2 group
			{ -0.593217	,-0.573224	,0.336097	,0.185005	,0.307045 },
			{ -0.530397	,-0.415781	,0.350586	,0.502316	,0.55137  },
			{ -0.763116	,-0.172789	,0.28147	,0.534382	,0.141261 },
			{ -0.522789	,-0.0661482	,0.426686	,0.268058	,0.477286 }
		}
	};

	float conv1_bias[2] = { 0.261754, 0.284783 };


	float conv2_weight[4][2][5][5] = 
	{
		{
			{
				{ 0.0391632	,0.24275	,0.0764835		,0.223479	,-0.180354 }, // The 1 group & 1 channel
				{ 0.216289	,0.201759	,-0.000725828	,-0.324395	,-0.372187 },
				{ 0.0964632	,0.203572	,0.126847		,-0.644174  ,-0.374058 },
				{ 0.250528	,0.133104	,0.119259		,-0.316472	,-0.231984 },
				{-0.0284423	,0.0570773	,-0.00795928	,-0.199945	,-0.0563125}
			},
			{
				{-0.136232	,0.245382	,0.51277		,-0.158831	,-0.516164 }, // The 1 group & 2 channel
				{-0.0756231	,0.44881	,0.229395		,-0.778041	,0.242146  },
				{0.329455	,0.618267	,0.541599		,-0.606366	,0.362031  },
				{0.118811	,0.625934	,0.415977		,-0.437599	,0.00356532},
				{0.27503	,0.270688	,0.394498		,-0.233472	,0.013437  }
			}
		},
		{
			{
				{ 0.170121	,0.0227367	,-0.1274		,-0.0148693	,0.0935144 }, // The 2 group & 1 channel
				{ 0.153735	,0.118483	,0.141526		,-0.00982931,0.0131488 },
				{ -0.150648	,0.0409035	,0.0917746		,-0.0527873	,0.0388685 },
				{ 0.0898141	,0.108939	,0.0368508		,0.187902	,0.155273  },
				{ 0.21255	,-0.131889	,-0.191455		,0.259616	,0.0534298 }
			},
			{
				{ 0.0937873 ,- 0.228983	,0.278982		,0.429355	,0.0574906 },// The 2 group & 2 channel
				{ 0.0111121	,0.0914836	,0.471327		,0.149127	,0.0573395 },
				{ 0.0566026	,0.334861	,0.542882		,0.345841	,0.0463876 },
				{ 0.335874	,0.321195	,0.251947		,0.17809	,0.165421  },
				{ 0.24033	,0.13706	,-0.0187079		,0.119356	,-0.192698 }
			}
		},
		{
			{
				{ 0.309212	,-0.319144	,-0.322148		,0.00378981	,0.183588  }, // The 3 group & 1 channel
				{ 0.271955	,-0.737417	,-0.378012		,-0.286001	,0.172062  },
				{ -0.45563  ,-0.627468	,-0.286014		,-0.183965	,0.0745775 },
				{ -0.308173 ,-0.3028	,0.22982		,0.123905	,0.145123  },
				{ -0.0163633,0.351586	,0.232321		,0.240255	,-0.0567902}
			},
			{
				{ 0.143836	,-0.265141	,-0.224084		,0.296968	,0.268145 }, // The 3 group & 2 channel
				{ -0.281704 ,-0.677106	,-0.0828011		,0.419801	,0.47929  },
				{ -0.329648 ,-0.135799	,0.285076		,0.377989	,0.147855 },
				{ -0.0806672,0.614311	,0.612885		,0.145643	,0.221215 },
				{ 0.399095	,0.487139	,0.187044		,0.388169	,0.262232 }
			}
		},
		{
			{
				{ 0.0968957 ,-0.00295202,0.206723		,-0.0790325 ,-0.0765204 }, // The 4 group & 1 channel
				{ 0.320764	,0.42328	,0.0967987		,0.348229	,0.405265	},
				{ 0.137662	,0.124809	,0.321469		,0.327368	,0.12199	},
				{ 0.202743	,0.189605	,-0.0956639		,-0.147701	,0.083409	},
				{-0.479937	,-0.25389	,-0.123276		,-0.0713367	,0.104588	}
			},
			{
				{ -0.184484	,-0.0346969	,-0.0640932		,0.173564	,0.114624	},// The 4 group & 2 channel
				{ 0.123316	,0.0917011	,0.244109		,0.0462284	,0.326303	},
				{ -0.0843373,-0.147215	,0.0754395		,-0.421187	,-0.554034	},
				{ -0.443893	,-0.243046	,-0.37113		,-0.423311	,-0.494327	},
				{ -0.132428	,-0.288912	,-0.18588		,0.106502	,0.0604231	}
			}
		}
	};

	float conv2_bias[4] = { -0.246126 , 0.150032 , 0.412865 , 0.220371 };

/*==================================================================================*/

/*==========conv1===================================================================*/
	
	//	out	[channel][x][y]
	float conv1_out[2][28][28] = { 0 };
	

	// conv. for 5x5x1x2 kernel
	for (int k = 0; k < 2; k++)  // group = 2
	{
		for (int i = 0; i < 28; i++)  // 32-5+1
			for (int j = 0; j < 28; j++) // 32-5+1 
			{
				for (int a = 0; a < 5; a++) // kernel size = 5
				{
					for (int b = 0; b < 5; b++) // kernel size = 5
						conv1_out[k][i][j] += pic[i + a][j + b] * conv1_weight[k][a][b];
				}
				conv1_out[k][i][j] += conv1_bias[k];
			}
	}


	printf("###### conv1 out #########\n");

	//print
	for (int k = 0; k < 2; k++)
	{
		for (int i = 0; i < 28; i++)
		{
			for (int j = 0; j < 28; j++)
			{
				printf("%6.2f\t", conv1_out[k][i][j]);
			}
			printf("\n");
		}
		printf("\n");
	}

	printf("\n\n\n");
/*==================================================================================*/

/*============ReLU1=================================================================*/

	//	out	[channel][x][y]
	float ReLU1_out[2][28][28] = { 0 };

	// ReLU
	for (int k = 0; k < 2; k++)
		for (int i = 0; i < 28; i++)
			for (int j = 0; j < 28; j++)
			{
				if (conv1_out[k][i][j] > 0)
				{
					ReLU1_out[k][i][j] = conv1_out[k][i][j];
				}
				else
				{
					ReLU1_out[k][i][j] = 0;
				}
			}

	printf("###### ReLU1 out #########\n");

	//print
	for (int k = 0; k < 2; k++)
	{
		for (int i = 0; i < 28; i++)
		{
			for (int j = 0; j < 28; j++)
			{
				printf("%6.2f\t", ReLU1_out[k][i][j]);
			}
			printf("\n");
		}
		printf("\n");
	}

	printf("\n\n\n");

/*==================================================================================*/
/*===========pooling1===============================================================*/
	
	//	out	[channel][x][y]
	float pooling1_out[2][14][14] = { 0 };


	//	2x2 average pooling
	for (int k = 0; k<2; k++) // channel = 2
		for (int i = 0; i < 14; i++)  //  28/2
			for (int j = 0; j < 14; j++)  //  28/2
			{
				for (int a = 0; a < 2; a++) // pooling size = 2
				{
					for (int b = 0; b < 2; b++)  // pooling size = 2
						pooling1_out[k][i][j] += ReLU1_out[k][i * 2 + a][j * 2 + b];
				}
				pooling1_out[k][i][j] = pooling1_out[k][i][j] / 4;
			}


	printf("######pooling1 out#########\n");

	//  print
	for (int k = 0; k < 2; k++)
		for (int i = 0; i < 14; i++)
		{
			for (int j = 0; j < 14; j++)
			{
				printf("%6.2f\t", pooling1_out[k][i][j]);
			}
			printf("\n");
		}

	printf("\n\n\n");

/*==================================================================================*/

/*============conv2=================================================================*/

//	out	[channel][x][y]
	float conv2_out[4][10][10] = { 0 };

	// 5x5 conv.
	for (int k = 0; k < 4; k++)  // output channel = 4 = kernel group
	{
		for (int i = 0; i < 10; i++)  // 14-5+1
			for (int j = 0; j < 10; j++)  // 14-5+1
			{
				for (int c = 0; c < 2; c++)  //  kernel channel#
				{
					for (int a = 0; a < 5; a++)  // kernel size
						for (int b = 0; b < 5; b++)
							conv2_out[k][i][j] += pooling1_out[c][i + a][j + b] * conv2_weight[k][c][a][b];
				}
				conv2_out[k][i][j] += conv2_bias[k];
			}
	}


	printf("######conv2 out#########\n");

	//print
	for (int k = 0; k < 4; k++)
	{
		for (int i = 0; i < 10; i++)
		{
			for (int j = 0; j < 10; j++)
			{
				printf("%8.2f\t", conv2_out[k][i][j]);
			}
			printf("\n");
		}
		printf("\n");
	}
	printf("\n\n\n");

/*==================================================================================*/

/*============ReLU2========================================================*/

//	out	[channel][x][y]
	float ReLU2_out[4][10][10] = { 0 };

	// ReLU
	for (int k = 0; k < 4; k++)
		for (int i = 0; i < 10; i++)
			for (int j = 0; j < 10; j++)
			{
				if (conv2_out[k][i][j] > 0)
				{
					ReLU2_out[k][i][j] = conv2_out[k][i][j];
				}
				else
				{
					ReLU2_out[k][i][j] = 0;
				}
			}

	printf("###### ReLU2 out #########\n");

	//print
	for (int k = 0; k < 4; k++)
	{
		for (int i = 0; i < 10; i++)
		{
			for (int j = 0; j < 10; j++)
			{
				printf("%8.2f\t", ReLU2_out[k][i][j]);
			}
			printf("\n");
		}
		printf("\n");
	}

	printf("\n\n\n");

/*==================================================================================*/

/*============pooling2==============================================================*/
	
//	out	[channel][x][y]
	float pooling2_out[4][5][5] = { 0 };


	//	2x2 average pooling
	for (int k = 0; k<4; k++) // channel = 4
		for (int i = 0; i < 5; i++)  //  10/2
			for (int j = 0; j < 5; j++)  //  10/2
			{
				for (int a = 0; a < 2; a++) // pooling size = 2
				{
					for (int b = 0; b < 2; b++)  // pooling size = 2
						pooling2_out[k][i][j] += ReLU2_out[k][i * 2 + a][j * 2 + b];
				}
				pooling2_out[k][i][j] = pooling2_out[k][i][j] / 4;
			}


	printf("######pooling2 out#########\n");

	//  print
	for (int k = 0; k < 4; k++)
	{
		for (int i = 0; i < 5; i++)
		{
			for (int j = 0; j < 5; j++)
			{
				printf("%8.2f\t", pooling2_out[k][i][j]);
			}
			printf("\n");
		}
		printf("\n");
	}
	printf("\n\n\n");

	
/*==================================================================================*/

/*============classification========================================================*/





/*==================================================================================*/



	system("pause");

	return 0;
}